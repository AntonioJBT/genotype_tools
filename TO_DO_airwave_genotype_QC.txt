#####################
Plan for genotype QC for Airwave
#####################

#####################
Gao He
Vangelis
Daivd M
Antonio B
#####################

#####################
Current state:
- The plan is to create a QC pipeline based on Plink and other tools that can be automated using Ruffus and CGAT tools. The overall effort is towards reproducibility, sharing tools, teamwork, etc. I'm way behind schedule on the actual genotype tools as there has been a lot more setting up (and other work...) than I expected...
- Based on Gao's and other work the genotype data looks very good in general. 
- The HPC team has installed ruffus and drmaa though, these are working. David and I have been testing these and everything seems in order. 
- I've installed (in my user space) the CGAT Pipeline framework, others may need to do this as well later on. The CGAT tools work well for me, they required some manual installation of serveral of the python libraries though. I also made some changes so that they could communicate with PBS Pro, these work without problems. There has been a recent switch to python 3 though so I have to test the modifications in the CGAT scripts. Not expecting problems though (famous last words)...

- The general approach is based on basic python organisation:
	+ Scripts - Write stand-alon scripts which are callable from the CLI and can take arbitrary parameters
	+ Modules - Include functions and code, which could be used by more than one script/pipeline, bundled by overall aim
	+ Pipeline - a (ruffus) python script which chains multiple tasks and jobs and can be submitted to the cluster (managed by drmaa).
	+ And ideally:
		+ Unit tests - aim to test each script, parameter, function, with small, example data. Aimed for stability only (ie do new code changes mess up the expected results?). Use via Travis CI or Jenkins CI, integrated to GitHub (tests are automatically triggered after each commit, need configuration (eg yaml), data and expected result).
	+ Report - aim to write a basic automated report that picks up some basic stats and plots for the pipeline (sphinx, markdown, or similar for example).
#####################

#####################
Future:
- I'm expecting that future pipelines can be written in the same way (to save time, for transparency, automation, re-use, etc.)
- After the QC steps we will discuss the need for an imputation pipeline and what to do with the different platforms. i.e. Merge them, run as validation, as meta-analysis, etc. This may be project/question dependent though.
- For imputation it would be ideal to do it ourselves. This needs person programming time and accessing the latest reference panel (we should try to get the HRC, Vangelis is looking into this).
#####################

#####################
TO DO LIST for the actual genotype QC pipeline, main things:

- Turn this plan into an actual pipeline! I had many problems installing some of the dependencies but these seem settled now. I'm hoping the effort will pay off.
- Most of the scripts (from Gao and I and third party) are ready but need cleaning up, making sure they are callable and put into a pipeline.
- Gao, Vangelis and I have discussed and agreed the steps to follow. These basically mirror de UK Biobank set up.

- For Antonio: merge CGAT Py3 and test PBSPro again.
#####################


#####################
Gao has done cleaning up, formatting, sanity checks, etc. 

I’ve updated the alleles (from A/B to TOP/BOT annotation), strand and genome build. Here’s the allele counts for batch 1 and it looks alright (similar for the other batches). 
 
Based on the updated new plink files, I calculated the sample and SNP missingness and HWE p-values PER BATCH and it looks this:
 
Sample missingness is very low in general. SNP missingness looks ok for all batches except for n23 and n46. (I think when calculating the SNP call rates, we need to exclude the non-autosomal SNPs. )
 
The script (2_alleleBuildUpdate.pbs, 3_quickCheck.pbs) and files are all in the folder /groupvol/med-bio/epiUKB/Airwave/coreExome_genotype/plinkFiles. They are generated for information purpose and can be removed if we don’t need them later.
 

I’ve fixed the four batches and the plink files have been generated. In case you need to run any loop there should be no problem now.
 
Btw, I calculated the number of samples and some full batches do not have 288 samples in the intensity files (and therefore also in the plink files). Here’s the details:
Haven’t figured out why it’s the case (due to sample failure, or duplication etc), but just let you know that not all the full batches have 288 samples.



Subject: RE: airwave QC discussion
From: "Gao, He" <h.gao@imperial.ac.uk>
Date: 19/09/2016, 17:17
To: "Berlanga, Antonio J" <a.berlanga@imperial.ac.uk>
CC: "Evangelou, Evangelos" <e.evangelou@imperial.ac.uk>

The script (2_alleleBuildUpdate.pbs, 3_quickCheck.pbs) and files are all in the folder /groupvol/med-bio/epiUKB/Airwave/coreExome_genotype/plinkFiles. They are generated for information purpose and can be removed if we don’t need them later.


#####################


#####################
PIPELINE STEPS:

QC of markers first, then individual samples:

- GenomeStudio to plink, hg19 liftover, flip strand

              GH: here are the steps and tools for this task
              1) GenomeStudio to plink: by zcall script; already done
              2) convert from AB allele to illumina TOP/BOT annotation: by plink, using Wrayner's annotation files; I can do it
              3) hg19/build 37 liftover: by plink, using Wrayner's annotation files, also handles strand; I can do it

- Allele frequency report with proportions:
	plink2 --bifle xxx --freq
	cat plink.frq | tr -s ' ' '\t' | cut -f 4 | grep A | wc -l # First column is a tab, so fourth is A1

- Select homogeneous set of samples to use as set for marker QC (PCA based, with automatic selection using e.g. 'aberrant' R package. This is to avoid artefacts from population structure. Excluded samples are later re-introduced.):
http://bioinformatics.oxfordjournals.org/content/28/1/134.full.pdf+html
Use summary statistics, and/or: missingness, ancestry, probe intensity, gender separately:
	- Merge plates first
	- Run PCA against 1000G (or Hapmap) as in UKB appendix 1 (requires using plink MAF >5%, HWE 10^-6, etc for Hapmap or 1000G, then projecting onto these)
	- aberrant with lambda set to 20 for ancestry PC1 and PC2 as summary stats

- Per batch marker QC (plink commands; drop failing SNPs from all plates):
     + Exclude monomorphic SNPs
     + Genotype call rate (<98%)
     + Genotype frequency consistency across batches (Fisher's exact test p-value <10^-12)
     + Allele frequency consistency versus reference panel (eg Hapmap, Fisher's exact test p-value <10^-12)
     + Hardy Weinberg equilibrium (p-value <10^-12)

- Plate/batch PCA (visual outlier detection check)

- Plate/batch merge

- Visual test of genotype calls in cluster plots (bin by MAF, pick random subset)

- Pooled sample QC (all samples; based on high quality set of markers from above; plink commands):

     + Run with autosomal SNPs only
     + Heterozygosity (standard deviation > +/- 3) and genotype failure rates per individual (>5%)
     + Relatedness between individuals (IBD cut-off >0.185)
     + Gender mis-identification check

- VCF check sanity (strand, problematic SNPs, etc.)

- Imputation + post-imputation QC (we can discuss this at a later stage)

- If several platforms, re-run whole script with each platform as separate batch

- Final set of QC'd and imputed individuals and markers can then be processed depending on specific question, eg:
     + Filter out MAF <1%
     + Ancestry PCA (e.g. vs Hapmap populations), filter out on PC2 values <0.072
     + Filter out mitochondrial and sex chromosomes

- VCF check sanity (strand, problematic SNPs, etc.)
#####################

#####################
Notes for Airwave data: 

- There are three platforms: Exome, CoreExome and an Affy chip
- Plates 1-27 are batch 1, 28-53 are batch 2.
#####################


#####################
References
General protocols and references:
http://www.ukbiobank.ac.uk/wp-content/uploads/2014/04/UKBiobank_genotyping_QC_documentation-web.pdf
http://www.nature.com/nprot/journal/v5/n9/pdf/nprot.2010.116.pdf
http://www.nature.com/nprot/journal/v10/n9/pdf/nprot.2015.077.pdf
http://www.nature.com/ng/journal/vaop/ncurrent/pdf/ng.3656.pdf

Also see:
Quality control and conduct of genome-wide association meta-analyses
http://www.nature.com/nprot/journal/v9/n5/full/nprot.2014.071.html
#####################

#####################
Basic protocol for association analysis:
Basic statistical analysis in genetic case-control studies
http://www.nature.com/nprot/journal/v6/n2/abs/nprot.2010.182.html
#####################


#####################
Other references to check:

Eagle v2.3 User Manual
https://data.broadinstitute.org/alkesgroup/Eagle/

Reference-based phasing using the Haplotype Reference Consortium panel : Nature Genetics : Nature Research
http://www.nature.com/ng/journal/v48/n11/full/ng.3679.html

Population-specific genotype imputations using minimac or IMPUTE2 - nprot.2015.077.pdf
http://www.nature.com/nprot/journal/v10/n9/pdf/nprot.2015.077.pdf

ExonChipProcessing/BatchAlleleFreqMatrix.R at master · slzhao/ExonChipProcessing
https://github.com/slzhao/ExonChipProcessing/blob/master/BatchAlleleFreqMatrix.R

gabraham/flashpca: Fast Principal Component Analysis of Large-Scale Genome-Wide Data
https://github.com/gabraham/flashpca#R

Scaling probabilistic models of genetic variation to millions of humans : Nature Genetics : Nature Research
http://www.nature.com/ng/journal/v48/n12/full/ng.3710.html

Testing for genetic associations in arbitrarily structured populations : Nature Genetics : Nature Research
http://www.nature.com/ng/journal/v47/n5/full/ng.3244.html

LD Score regression distinguishes confounding from polygenicity in genome-wide association studies
http://www.nature.com/ng/journal/v47/n3/full/ng.3211.html
https://github.com/bulik/ldsc

Also check if Variance inflation factor need calculating and adjusting for. See methods in:
Identification of 15 genetic loci associated with risk of major depression in individuals of European descent
http://www.nature.com/ng/journal/v48/n9/full/ng.3623.html
500,000 subjects
#####################


#####################
Downstream annotation, some to check later on:
DEPICT Biological interpretation of genome-wide association studies using predicted gene functions.
http://www.ncbi.nlm.nih.gov/pubmed/25597830?dopt=Abstract&holding=npg
#####################
